<link rel="stylesheet" type="text/css" href="static/style.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

{% extends "base.html" %}

{% block content %}
<h1>Dashboard</h1>
<p>Welcome to the CyberLotus Project dashboard.</p>

<!-- Emergency Stop Button -->
<button class="btn btn-danger" onclick="confirmEmergencyStop()">Emergency Stop</button>
<button class="btn btn-primary" onclick="getSystemStats()">Refresh Stats</button>

<div class="dashboard-panel">
  <table id="systemStatsTable">
    <thead>
      <tr>
        <th>Sensor/Relay</th>
        <th>Value</th>
        <th>Timestamp</th>
      </tr>
    </thead>
    <tbody>
      <!-- Rows will be dynamically added -->
    </tbody>
  </table>
</div>

<script>
function getSystemStats() {
  fetch("/sys_state")
    .then(response => response.json())
    .then(data => {
      console.log(data);
      updateTable(data);
    })
    .catch(error => {
      console.error('Error:', error);
    });
}

function confirmEmergencyStop() {
  if (confirm("Are you sure you want to activate the EMERGENCY STOP? This will immediately stop all pumps!")) {
    fetch('/emergency_stop', { method: 'POST' })
      .then(response => response.json())
      .then(data => alert(data.message))
      .catch(error => {
        alert("Failed to send Emergency Stop command.");
        console.error('Error:', error);
      });
  }
}

function updateTable(data) {
  const tableBody = document.getElementById("systemStatsTable").getElementsByTagName("tbody")[0];
  
  // Clear existing rows
  tableBody.innerHTML = "";

  // Add rows dynamically
  Object.keys(data).forEach(key => {
    if (["ec", "ph", "temperature"].includes(key)) {
      addRow(tableBody, key.toUpperCase(), data[key].value, data[key].timestamp);
    } else if (["tank_1", "tank_2", "tank_3"].includes(key)) {
      addRow(tableBody, key.toUpperCase(), `${data[key].level}%`, data[key].timestamp);
    } else if (key === "relay_states") {
      Object.keys(data[key]).forEach(relayKey => {
        const state = data[key][relayKey].state === "ON" 
          ? `<i class="fas fa-toggle-on" style="color: green;"></i> ON` 
          : `<i class="fas fa-toggle-off" style="color: red;"></i> OFF`;
        addRow(tableBody, relayKey.toUpperCase(), state, data[key][relayKey].timestamp);
      });
    } else if (key === "ec_calibration") {
      Object.keys(data[key]).forEach(calibrationKey => {
        addRow(
          tableBody, 
          calibrationKey.toUpperCase(), 
          data[key][calibrationKey]?.value || "N/A", 
          data[key][calibrationKey]?.timestamp
        );
      });
    }
  });
}

function addRow(tableBody, name, value, timestamp) {
  const row = tableBody.insertRow();
  row.insertCell(0).textContent = name;
  row.insertCell(1).innerHTML = value || "N/A";
  row.insertCell(2).textContent = timestamp 
    ? new Date(timestamp * 1000).toLocaleString() 
    : "N/A";
}

// Initial fetch
getSystemStats();
</script>

{% endblock %}
