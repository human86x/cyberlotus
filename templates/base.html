<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberLotus Project</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            flex-direction: column;
            overflow: hidden;
        }
        .main-content {
            display: flex;
            flex: 1;
            min-height: 0;
        }
        .sidebar {
            width: 250px;
            background-color: #333;
            color: #fff;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            transition: transform 0.3s ease;
            position: relative;
            z-index: 10;
        }
        .sidebar.collapsed {
            transform: translateX(-250px);
        }
        .sidebar-toggle {
            position: absolute;
            right: -40px;
            top: 10px;
            width: 40px;
            height: 40px;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
        }
        .sidebar h2 {
            margin-top: 0;
        }
        .sidebar a {
            display: block;
            color: #fff;
            text-decoration: none;
            padding: 10px 0;
            margin: 10px 0;
            border-bottom: 1px solid #555;
        }
        .sidebar a:hover {
            background-color: #555;
        }
        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            transition: margin-left 0.3s ease;
        }
        .content.expanded {
            margin-left: -250px;
        }
        .right-sidebar {
            width: 300px;
            background-color: #f0f0f0;
            padding: 20px;
            box-sizing: border-box;
            border-left: 1px solid #ddd;
            overflow-y: auto;
        }
        #systemStatsTable {
            width: 100%;
            border-collapse: collapse;
        }
        #systemStatsTable td {
            padding: 8px;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
        }
        #systemStatsTable .section-header {
            background-color: #e0e0e0;
            font-weight: bold;
            border-bottom: 2px solid #bbb;
        }
        #systemStatsTable .section-header td {
            padding: 10px 8px;
        }
        .sensor-value {
            font-weight: bold;
        }
        .timestamp {
            color: #666;
            font-size: 12px;
        }
        .good-value {
            color: green;
        }
        .warning-value {
            color: orange;
        }
        .danger-value {
            color: red;
        }
        .console-panel {
            height: 120px;
            background-color: #111;
            color: #0f0;
            font-family: monospace;
            padding: 10px;
            overflow-y: auto;
            border-top: 2px solid #333;
        }
        #consoleOutput {
            white-space: pre-wrap;
            margin: 0;
            padding: 0;
            line-height: 1.4;
        }
        #consoleOutput div {
            margin: 2px 0;
        }
        .console-anchor {
            height: 1px;
        }
    </style>
</head>
<body>
    <div class="main-content">
        <div class="sidebar" id="sidebar">
            <button class="sidebar-toggle" id="sidebarToggle">
                <i class="fas fa-chevron-left" id="toggleIcon"></i>
            </button>
            <h2>CyberLotus</h2>
            <a href="{{ url_for('dashboard') }}">Dashboard</a>
            <a href="{{ url_for('relays') }}">Relays</a>
            <a href="{{ url_for('tanks') }}">Tanks</a>
            <a href="{{ url_for('pumps') }}">Pumps</a>
            <a href="{{ url_for('sequences') }}">Sequences</a>
            <a href="{{ url_for('ph') }}">pH</a>
            <a href="{{ url_for('ec') }}">EC</a>
            <a href="{{ url_for('ecosystem') }}">Ecosystem</a>
            <a href="{{ url_for('automatisation') }}">Automatisation</a>
            <a href="{{ url_for('plant_chamber') }}">Plant Chamber</a>
        </div>
        <div class="content" id="mainContent">
            {% block content %}{% endblock %}
            <form action="{{ url_for('emergency_stop_route') }}" method="post">
                <button type="submit">ðŸš¨ Emergency Stop</button>
            </form>
        </div>
        <div class="right-sidebar">
            <table id="systemStatsTable">
                <tbody id="systemStatsBody">
                    <!-- Plant Chamber Section -->
                    <tr class="section-header">
                        <td colspan="4"><i class="fas fa-seedling"></i> Plant Chamber</td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-temperature-half"></i></td>
                        <td>Chamber Temp</td>
                        <td class="sensor-value" data-key="chamber_temperature">-</td>
                        <td class="timestamp">-</td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-bullseye"></i></td>
                        <td>Target Temp</td>
                        <td class="sensor-value" data-key="plant_chamber_target_temperature">-</td>
                        <td class="timestamp">-</td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-droplet"></i></td>
                        <td>Humidity</td>
                        <td class="sensor-value" data-key="chamber_humidity">-</td>
                        <td class="timestamp">-</td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-bullseye"></i></td>
                        <td>Target Humidity</td>
                        <td class="sensor-value" data-key="plant_chamber_target_humidity">-</td>
                        <td class="timestamp">-</td>
                    </tr>
                    
                    <!-- Nutrient Solution Section -->
                    <tr class="section-header">
                        <td colspan="4"><i class="fas fa-flask"></i> Nutrient Solution</td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-flask"></i></td>
                        <td>EC</td>
                        <td class="sensor-value" data-key="ec">-</td>
                        <td class="timestamp">-</td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-bullseye"></i></td>
                        <td>Target EC</td>
                        <td class="sensor-value" data-key="target_NPK">-</td>
                        <td class="timestamp">-</td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-vial"></i></td>
                        <td>pH</td>
                        <td class="sensor-value" data-key="ph">-</td>
                        <td class="timestamp">-</td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-bullseye"></i></td>
                        <td>Target pH</td>
                        <td class="sensor-value" data-key="target_pH">-</td>
                        <td class="timestamp">-</td>
                    </tr>
                    
                    <!-- Tanks Section -->
                    <tr class="section-header">
                        <td colspan="4"><i class="fas fa-droplet"></i> Tanks</td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-droplet"></i></td>
                        <td>Solution Tank</td>
                        <td class="sensor-value" data-key="solution_tank">-</td>
                        <td class="timestamp">-</td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-bottle-water"></i></td>
                        <td>Fresh Water</td>
                        <td class="sensor-value" data-key="fresh_tank">-</td>
                        <td class="timestamp">-</td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-trash"></i></td>
                        <td>Waste Tank</td>
                        <td class="sensor-value" data-key="waste_tank">-</td>
                        <td class="timestamp">-</td>
                    </tr>
                    
                    <!-- Relays Section -->
                    <tr class="section-header">
                        <td colspan="4"><i class="fas fa-plug"></i> Relays</td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-fire"></i></td>
                        <td>Water Heater</td>
                        <td class="sensor-value" data-key="water_heater">-</td>
                        <td class="timestamp">-</td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-fire"></i></td>
                        <td>Air Heater</td>
                        <td class="sensor-value" data-key="air_heater">-</td>
                        <td class="timestamp">-</td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-wind"></i></td>
                        <td>Humidifier</td>
                        <td class="sensor-value" data-key="air_humidifyer">-</td>
                        <td class="timestamp">-</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="console-panel">
        <div id="consoleOutput">System console ready...</div>
        <div class="console-anchor"></div>
    </div>

    <script>
        // Sidebar toggle functionality
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const toggleIcon = document.getElementById('toggleIcon');
            
            let isCollapsed = false;
            
            sidebarToggle.addEventListener('click', function() {
                isCollapsed = !isCollapsed;
                
                if (isCollapsed) {
                    sidebar.classList.add('collapsed');
                    mainContent.classList.add('expanded');
                    toggleIcon.classList.remove('fa-chevron-left');
                    toggleIcon.classList.add('fa-chevron-right');
                } else {
                    sidebar.classList.remove('collapsed');
                    mainContent.classList.remove('expanded');
                    toggleIcon.classList.remove('fa-chevron-right');
                    toggleIcon.classList.add('fa-chevron-left');
                }
            });
            
            // Auto-collapse when mouse leaves sidebar
            let collapseTimeout;
            sidebar.addEventListener('mouseleave', function() {
                collapseTimeout = setTimeout(function() {
                    if (!isCollapsed) sidebarToggle.click();
                }, 3000);
            });
            
            sidebar.addEventListener('mouseenter', function() {
                clearTimeout(collapseTimeout);
                if (isCollapsed) sidebarToggle.click();
            });
        });

        // System stats update functions
        function updateSystemStats(data) {
            document.querySelectorAll('.sensor-value').forEach(cell => {
                const key = cell.getAttribute('data-key');
                const value = getValueFromData(data, key);
                
                if (value !== undefined && value !== null) {
                    // Update displayed value
                    cell.textContent = value.value !== undefined ? value.value : 
                                     value.state !== undefined ? value.state : 
                                     value.level !== undefined ? value.level : '-';
                    
                    // Update timestamp if available
                    const timestampCell = cell.parentElement.querySelector('.timestamp');
                    if (timestampCell && value.timestamp) {
                        timestampCell.textContent = new Date(value.timestamp * 1000).toLocaleTimeString();
                    }
                    
                    // Apply styling based on value
                    updateCellStyle(cell, key, cell.textContent);
                }
            });
        }

        function getValueFromData(data, key) {
            // Check main data first
            if (data[key]) return data[key];
            
            // Check relay states if not found
            if (data.relay_states && data.relay_states[key]) {
                return data.relay_states[key];
            }
            
            return null;
        }

        function updateCellStyle(cell, key, value) {
            // Reset previous classes
            cell.classList.remove('good-value', 'warning-value', 'danger-value');
            
            // Skip if not a number
            if (isNaN(value)) return;
            
            value = parseFloat(value);
            
            // Apply new classes based on value and key
            if (key.includes('temperature')) {
                if (value > 30) cell.classList.add('danger-value');
                else if (value > 28) cell.classList.add('warning-value');
                else cell.classList.add('good-value');
            } 
            else if (key.includes('ph')) {
                if (value < 5 || value > 7) cell.classList.add('danger-value');
                else if (value < 5.5 || value > 6.5) cell.classList.add('warning-value');
                else cell.classList.add('good-value');
            }
            // Add more conditions as needed
        }

        // Console functions
        let lastConsoleUpdate = 0;
        const consoleUpdateInterval = setInterval(updateConsole, 300);
        let consoleUpdateInProgress = false;
        
        function updateConsole() {
            if (consoleUpdateInProgress) return;
            consoleUpdateInProgress = true;
            
            fetch('/console_output?ts=' + lastConsoleUpdate)
                .then(response => response.json())
                .then(data => {
                    if (data.console_messages?.length > 0) {
                        const newMessages = data.console_messages.filter(
                            msg => msg.timestamp > lastConsoleUpdate
                        );
                        
                        if (newMessages.length > 0) {
                            lastConsoleUpdate = data.timestamp;
                            appendConsoleMessages(newMessages);
                        }
                    }
                })
                .catch(console.error)
                .finally(() => {
                    consoleUpdateInProgress = false;
                });
        }

        function appendConsoleMessages(messages) {
            const consoleOutput = document.getElementById('consoleOutput');
            const fragment = document.createDocumentFragment();
            
            messages.forEach(msg => {
                const messageElement = document.createElement('div');
                const timestamp = new Date(msg.timestamp * 1000).toLocaleTimeString();
                messageElement.textContent = `[${timestamp}] ${msg.message}`;
                fragment.appendChild(messageElement);
            });
            
            consoleOutput.insertBefore(fragment, document.querySelector('.console-anchor'));
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            // Load system stats
            fetch("/sys_state")
                .then(response => response.json())
                .then(data => updateSystemStats(data))
                .catch(console.error);
            
            // Set up periodic updates
            setInterval(() => {
                fetch("/sys_state")
                    .then(response => response.json())
                    .then(data => updateSystemStats(data))
                    .catch(console.error);
            }, 5000);
            
            // Initial console message
            setTimeout(() => {
                appendConsoleMessages([{
                    message: "System initialized and ready",
                    timestamp: Date.now() / 1000
                }]);
            }, 100);
        });
    </script>
</body>
</html>