<div class="right-sidebar">
    <table id="systemStatsTable">
        <thead>
            <tr>
                <th colspan="4">System Measurements</th>
            </tr>
        </thead>
        <tbody id="systemStatsBody">
            <!-- Data will be inserted here -->
        </tbody>
    </table>
</div>

<style>
    /* Update these styles in your existing CSS */
    .right-sidebar {
        width: 300px;
        background-color: #f8f9fa;
        padding: 15px;
        box-sizing: border-box;
        border-left: 1px solid #dee2e6;
        overflow-y: auto;
    }
    
    #systemStatsTable {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 0.9em;
    }
    
    #systemStatsTable th {
        background-color: #e9ecef;
        position: sticky;
        top: 0;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.8em;
        letter-spacing: 0.5px;
    }
    
    #systemStatsTable th, #systemStatsTable td {
        border: 1px solid #dee2e6;
        padding: 8px 10px;
        text-align: left;
    }
    
    .group-header {
        background-color: #e9ecef !important;
        font-weight: 600;
        color: #495057;
    }
    
    .group-header i {
        margin-right: 8px;
        color: #6c757d;
    }
    
    .sensor-value {
        font-weight: bold;
    }
    
    .good-value {
        color: #28a745;
    }
    
    .warning-value {
        color: #fd7e14;
    }
    
    .danger-value {
        color: #dc3545;
    }
    
    .icon-cell {
        width: 24px;
        text-align: center;
        color: #6c757d;
    }
    
    .sensor-name {
        min-width: 120px;
        font-weight: 500;
        color: #495057;
    }
    
    .status-on {
        color: #28a745;
    }
    
    .status-off {
        color: #6c757d;
    }
    
    .target-value {
        color: #6c757d;
        font-style: italic;
    }
    
    .timestamp {
        font-size: 0.8em;
        color: #adb5bd;
    }
</style>

<script>
    // Update the systemStatsOrder array with proper labels and organization
    const systemStatsOrder = [
        // Root Zone
        { key: "plant_pot_temperature", label: "Root Temperature", icon: "fa-seedling", group: "Root Zone" },
        { key: "target_root_temperature", label: "Target Root Temp", icon: "fa-bullseye", group: "Root Zone" },
        { key: "plant_pot_level", label: "Root Zone Level", icon: "fa-vial", group: "Root Zone" },
        { key: "target_pot_level", label: "Target Root Level", icon: "fa-bullseye", group: "Root Zone" },
        
        // Water System
        { key: "temperature", label: "Water Temperature", icon: "fa-temperature-half", group: "Water System" },
        { key: "target_temp", label: "Target Water Temp", icon: "fa-bullseye", group: "Water System" },
        { key: "ph", label: "pH Level", icon: "fa-vial", group: "Water System" },
        { key: "target_pH", label: "Target pH", icon: "fa-bullseye", group: "Water System" },
        { key: "ec", label: "EC Level", icon: "fa-flask", group: "Water System" },
        { key: "target_NPK", label: "Target EC", icon: "fa-bullseye", group: "Water System" },
        
        // Air Environment
        { key: "chamber_temperature", label: "Air Temperature", icon: "fa-temperature-half", group: "Air Environment" },
        { key: "target_air_temperature", label: "Target Air Temp", icon: "fa-bullseye", group: "Air Environment" },
        { key: "chamber_humidity", label: "Air Humidity", icon: "fa-droplet", group: "Air Environment" },
        { key: "target_humidity", label: "Target Humidity", icon: "fa-bullseye", group: "Air Environment" },
        
        // Lighting
        { key: "light_white", label: "White Light", icon: "fa-lightbulb", group: "Lighting" },
        { key: "light_yellow", label: "Yellow Light", icon: "fa-lightbulb", group: "Lighting" },
        { key: "light_grow", label: "Grow Light", icon: "fa-sun", group: "Lighting" },
        
        // Tanks
        { key: "solution_tank", label: "Nutrient Tank", icon: "fa-droplet", group: "Tanks" },
        { key: "fresh_tank", label: "Fresh Water Tank", icon: "fa-bottle-water", group: "Tanks" },
        { key: "waste_tank", label: "Waste Tank", icon: "fa-trash", group: "Tanks" },
        
        // Controls
        { key: "water_heater", label: "Water Heater", icon: "fa-fire", group: "Controls" },
        { key: "air_heater", label: "Air Heater", icon: "fa-fire", group: "Controls" },
        { key: "air_humidifyer", label: "Humidifier", icon: "fa-wind", group: "Controls" },
        { key: "stop_all", label: "Emergency Stop", icon: "fa-triangle-exclamation", group: "Emergency" }
    ];

    // Update the dashboard groups
    const dashboardGroups = [
        { name: "Root Zone", icon: "fa-seedling" },
        { name: "Water System", icon: "fa-tint" },
        { name: "Air Environment", icon: "fa-wind" },
        { name: "Lighting", icon: "fa-lightbulb" },
        { name: "Tanks", icon: "fa-droplet" },
        { name: "Controls", icon: "fa-sliders-h" },
        { name: "Emergency", icon: "fa-triangle-exclamation" }
    ];

    // Update the addTableRow function
    function addTableRow(tbody, key, item, icon) {
        const row = tbody.insertRow();
        
        // Find the label from systemStatsOrder
        const statConfig = systemStatsOrder.find(item => item.key === key);
        const label = statConfig ? statConfig.label : key.replace(/_/g, ' ').replace(/\btarget\b/gi, '').trim();
        
        // Icon cell
        const iconCell = row.insertCell();
        iconCell.className = "icon-cell";
        iconCell.innerHTML = `<i class="fas ${icon || iconMap[key] || 'fa-circle-info'}"></i>`;
        
        // Name cell
        const nameCell = row.insertCell();
        nameCell.className = "sensor-name";
        nameCell.textContent = label;
        
        // Value cell
        const valueCell = row.insertCell();
        let displayValue = "N/A";
        if (item.value !== undefined && item.value !== null) displayValue = item.value;
        else if (item.state !== undefined && item.state !== null) displayValue = item.state;
        else if (item.level !== undefined && item.level !== null) displayValue = item.level;
        
        // Handle ON/OFF states with icons and colors
        if (typeof displayValue === 'string' && (displayValue.toLowerCase() === 'on' || displayValue.toLowerCase() === 'off')) {
            const isOn = displayValue.toLowerCase() === 'on';
            valueCell.innerHTML = `<span class="sensor-value ${isOn ? 'status-on' : 'status-off'}">
                <i class="fas ${isOn ? 'fa-power-off' : 'fa-power-off'}"></i> ${displayValue}
            </span>`;
        } else {
            valueCell.innerHTML = `<span class="sensor-value">${displayValue}</span>`;
            
            // Apply value coloring based on conditions
            if (typeof displayValue === 'number') {
                if (key.includes('temperature')) {
                    if (displayValue > 30) valueCell.classList.add('danger-value');
                    else if (displayValue > 28) valueCell.classList.add('warning-value');
                    else valueCell.classList.add('good-value');
                } else if (key.includes('ph')) {
                    if (displayValue < 5 || displayValue > 7) valueCell.classList.add('danger-value');
                    else if (displayValue < 5.5 || displayValue > 6.5) valueCell.classList.add('warning-value');
                    else valueCell.classList.add('good-value');
                } else if (key.includes('humidity')) {
                    if (displayValue < 30 || displayValue > 80) valueCell.classList.add('danger-value');
                    else if (displayValue < 40 || displayValue > 70) valueCell.classList.add('warning-value');
                    else valueCell.classList.add('good-value');
                } else if (key.includes('level')) {
                    if (displayValue < 20) valueCell.classList.add('danger-value');
                    else if (displayValue < 40) valueCell.classList.add('warning-value');
                    else valueCell.classList.add('good-value');
                }
            }
        }
        
        // Timestamp cell
        const timeCell = row.insertCell();
        timeCell.className = "timestamp";
        timeCell.textContent = item.timestamp ? 
            new Date(item.timestamp * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "N/A";
    }
</script>