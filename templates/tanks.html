<link rel="stylesheet" type="text/css" href="static/style.css" />
{% extends "base.html" %}

{% block content %}
<h1>Tank Calibration</h1>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert {{ category }}">{{ message }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}

<form id="tankForm">
    <label for="tank_name">Tank Name:</label>
    <input type="text" name="tank_name" id="tank_name" required>

    <label for="sensor_name">Sensor Name:</label>
    <select name="sensor_name" id="sensor_name" required>
        {% for sensor in sensors %}
            <option value="{{ sensor }}">{{ sensor }}</option>
        {% endfor %}
    </select>

    <label for="drain_pump">Select Draining Pump:</label>
    <select name="drain_pump" id="drain_pump" required>
        {% for pump in pump_names %}
            <option value="{{ pump }}">{{ pump }}</option>
        {% endfor %}
    </select>

    <label for="fill_pump">Select Filling Pump:</label>
    <select name="fill_pump" id="fill_pump" required>
        {% for pump in pump_names %}
            <option value="{{ pump }}">{{ pump }}</option>
        {% endfor %}
    </select>

    <h3>Calibration</h3>
    <button type="button" onclick="startCalibration()">Start Calibration</button>
</form>

<!-- Progress Bar -->
<div id="progressContainer" style="display:none; margin-top:20px;">
    <label for="progressBar">Progress:</label>
    <div style="width: 100%; background-color: #ccc;">
        <div id="progressBar" style="width: 0%; height: 30px; background-color: green; text-align: center; color: white;">
            0%
        </div>
    </div>
</div>

<script>
function startCalibration() {
    const tankName = document.getElementById('tank_name').value;
    const sensorName = document.getElementById('sensor_name').value;
    const drainPump = document.getElementById('drain_pump').value;
    const fillPump = document.getElementById('fill_pump').value;

    if (!tankName || !sensorName || !drainPump || !fillPump) {
        alert('Please fill out all fields.');
        return;
    }

    const data = { tank_name: tankName, sensor_name: sensorName, drain_pump: drainPump, fill_pump: fillPump };

    document.getElementById('progressContainer').style.display = 'block';
    document.getElementById('progressBar').style.width = '0%';
    document.getElementById('progressBar').innerText = '0%';

    fetch('/start_calibration', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(() => trackProgress(tankName))
    .catch(error => console.error('Error:', error));
}

function trackProgress(tankName) {
    const interval = setInterval(() => {
        fetch(`/get_progress/${tankName}`)
            .then(response => response.json())
            .then(data => {
                const progress = data.progress;
                const progressBar = document.getElementById('progressBar');
                progressBar.style.width = progress + '%';
                progressBar.innerText = progress + '%';

                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        document.getElementById('progressContainer').style.display = 'none';
                    }, 2000);
                } else if (progress === -1) {
                    clearInterval(interval);
                    alert('Error occurred during the operation.');
                }
            });
    }, 500);
}
</script>

<style>
    .alert.success { color: green; }
    .alert.error { color: red; }
</style>
{% endblock %}
