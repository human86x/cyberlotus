{% extends "base.html" %}

{% block content %}
<h2>Manage Tanks</h2>
<link rel="stylesheet" type="text/css" href="static/style.css" />
   
<!-- Tank Creation Form -->
<div class="form-container">
    <h3>Create New Tank</h3>
    <form action="{{ url_for('create_tank_route') }}" method="POST">
        <div class="form-group">
            <label for="name">Tank Name:</label>
            <input type="text" name="name" required>
        </div>

        <div class="form-group">
            <label for="code">Arduino Code (e.g., L1, L2):</label>
            <input type="text" name="code" required>
        </div>

        <div class="form-group">
            <label for="total_volume">Total Volume (L):</label>
            <input type="number" name="total_volume" step="0.1" required>
        </div>

        <div class="form-group">
            <label for="full_cm">Full Sensor Value (cm):</label>
            <input type="number" name="full_cm" step="0.1" required>
        </div>

        <div class="form-group">
            <label for="empty_cm">Empty Sensor Value (cm):</label>
            <input type="number" name="empty_cm" step="0.1" required>
        </div>

        <button type="submit">Add Tank</button>
    </form>
</div>

<hr>

<!-- Display Existing Tanks -->
<h3>Existing Tanks</h3>
<div id="tanks-display" style="display: flex; overflow-x: auto;"></div>

<hr>

<!-- Test Tanks Button -->
<h3>Test Tanks</h3>
<button onclick="fetchTankData()">Run Test</button>

<div id="test-results"></div>

<hr>

<!-- Solution Level Control -->
<h3>Adjust Solution Level</h3>
<input type="range" id="solution-level-slider" min="0" max="100" value="50" style="width: 300px;">
<span id="solution-level-display">50%</span>
<button id="save-solution-level-button">Save Level</button>

<script>
let solution_level = 50;

// Function to load the solution level on page load
function loadSolutionLevel() {
    fetch("{{ url_for('get_solution_level') }}")
        .then(response => response.json())
        .then(data => {
            if (data.solution_level !== undefined) {
                solution_level = data.solution_level;
                document.getElementById("solution-level-slider").value = solution_level;
                document.getElementById("solution-level-display").textContent = solution_level + "%";
            }
        })
        .catch(error => {
            console.error("Error loading solution level:", error);
        });
}

document.getElementById("solution-level-slider").addEventListener("input", function(event) {
    solution_level = event.target.value;
    document.getElementById("solution-level-display").textContent = solution_level + "%";
});

document.getElementById("save-solution-level-button").addEventListener("click", function() {
    // Send the current solution level to the server to save to JSON
    fetch("{{ url_for('save_solution_level_route') }}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ solution_level: solution_level })
    })
    .then(response => response.json())
    .then(data => {
        alert("Solution level saved successfully!");
    })
    .catch(error => {
        console.error("Error saving solution level:", error);
    });
});










document.getElementById("solution-level-slider").addEventListener("input", function(event) {
    solution_level = event.target.value;
    document.getElementById("solution-level-display").textContent = solution_level + "%";
});

document.getElementById("save-solution-level-button").addEventListener("click", function() {
    // Send the current solution level to the server to save to JSON
    fetch("{{ url_for('save_solution_level') }}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ solution_level: solution_level })
    })
    .then(response => response.json())
    .then(data => {
        alert("Solution level saved successfully!");
    })
    .catch(error => {
        console.error("Error saving solution level:", error);
    });
});



function fetchTankData() {
    fetch("{{ url_for('test_tanks_route') }}")
        .then(response => response.json())
        .then(data => {
            let tanksDisplay = document.getElementById("tanks-display");
            tanksDisplay.innerHTML = '';
            
            Object.keys(data).forEach(tank => {
                let result = data[tank];
                let tankDiv = document.createElement("div");
                tankDiv.className = "tank-card";
                tankDiv.style = "text-align: center; margin: 10px; display: inline-block;";
                tankDiv.innerHTML = `
                    <div style="height: 200px; width: 50px; background-color: #ddd; border: 1px solid #333; position: relative;">
                        <div id="${tank}-fill-bar" style="position: absolute; bottom: 0; width: 100%; background-color: green; height: ${result.fill_percentage}%;"></div>
                    </div>
                    <h4>${tank}</h4>
                    <p>Arduino Code: ${result.arduino_code}</p>
                    <p>Total Volume: ${result.total_volume} L</p>
                    <p>Full: ${result.full_cm} cm</p>
                    <p>Empty: ${result.empty_cm} cm</p>
                    <p>Fill Level: ${result.fill_percentage}%</p>
                `;
                tanksDisplay.appendChild(tankDiv);
            });
        })
        .catch(error => {
            console.error("Error fetching tank data:", error);
        });
}

// Load tank data on page load
window.onload = fetchTankData;
// Load solution level when the page loads
window.onload = loadSolutionLevel;
</script>

{% endblock %}