{% extends "base.html" %}

{% block content %}
<h2>Manage Tanks</h2>
<link rel="stylesheet" type="text/css" href="static/style.css" />

<!-- Display Existing Tanks -->
<h3>Existing Tanks</h3>
<div id="tanks-display" style="display: flex; overflow-x: auto;"></div>

<hr>

<!-- Test Tanks Button -->
<h3>Check Tanks Levels</h3>
<button onclick="fetchTankData()">Refresh</button>
<div id="test-results"></div>

<button onclick="drainWaste()" style="margin: 10px; padding: 10px 20px; background-color: #e74c3c; color: white; border: none; cursor: pointer;">
    Drain Waste Tank
</button>

<!-- Display result -->
<div id="drain-result" style="margin-top: 10px; font-weight: bold;"></div>



<hr>

<!-- Solution Level Control -->
<h3>Adjust Solution Tank Level</h3>
<div>
    <form id="pumpForm">
        <label for="fill_pump">Fill Pump:</label>
        <select name="fill_pump" id="fill_pump" required>
            {% for pump in pump_names %}
                <option value="{{ pump }}">{{ pump }}</option>
            {% endfor %}
        </select>
    
        <label for="drain_pump">Drain Pump:</label>
        <select name="drain_pump" id="drain_pump" required>
            {% for pump in pump_names %}
                <option value="{{ pump }}">{{ pump }}</option>
            {% endfor %}
        </select>
    </form>
    <br><br>
    <!-- Save Pump Assignments Button -->
    <button type="button" onclick="savePumpAssignments()">Save Pump Assignments</button>
    <button type="button" onclick="loadSavedPumpSelections();">Load Pump Assignments</button>











<!-- Solution Level Control -->



<!-- Button to trigger solution level comparison -->
<h3>Check Solution Level Adjustment</h3>
<button onclick="compareSolutionLevel()">Check Adjustment</button>

<div id="adjustment-results"></div>
<div id="progress-container" style="width: 100%; margin-top: 20px; display: none;"></div>
    <div id="progress-bar" style="width: 0%; height: 20px; background-color: #4CAF50;"></div>
</div>



<h3>Adjust Solution Tank Level</h3>
<div>
    <button id="adjustTankButton">Adjust Solution Tank</button>
    <div id="responseMessage"></div> <!-- To display success or error messages -->
    <input type="range" id="solution-level-slider" min="0" max="100" value="50" style="width: 300px;">
    <span id="solution-level-display">50%</span>
    <button id="save-solution-level-button">Save Level</button>
</div>






<!-- Tank Creation Form -->
<div class="form-container">
    <h3>Create New Tank</h3>
    <form action="{{ url_for('create_tank_route') }}" method="POST">
        <div class="form-group">
            <label for="name">Tank Name:</label>
            <input type="text" name="name" required>
        </div>

        <div class="form-group">
            <label for="code">Arduino Code (e.g., L1, L2):</label>
            <input type="text" name="code" required>
        </div>

        <div class="form-group">
            <label for="total_volume">Total Volume (L):</label>
            <input type="number" name="total_volume" step="0.1" required>
        </div>

        <div class="form-group">
            <label for="full_cm">Full Sensor Value (cm):</label>
            <input type="number" name="full_cm" step="0.1" required>
        </div>

        <div class="form-group">
            <label for="empty_cm">Empty Sensor Value (cm):</label>
            <input type="number" name="empty_cm" step="0.1" required>
        </div>

        <button type="submit">Add Tank</button>
    </form>
</div>

<hr>



<script>

function drainWaste() {
    let resultDisplay = document.getElementById("drain-result");
    resultDisplay.textContent = "Starting waste drain...";

    fetch("{{ url_for('drain_waste') }}", {
        method: "POST",
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "success") {
            resultDisplay.textContent = `Waste drained successfully using ${data.pump_used}!`;
        } else {
            resultDisplay.textContent = `Error: ${data.message}`;
        }
    })
    .catch(error => {
        console.error("Error draining waste:", error);
        resultDisplay.textContent = "Error starting drain process.";
    });
}





function savePumpAssignments() {
    // Get the selected values from the dropdowns
    const fillPump = document.getElementById('fill_pump').value;
    const drainPump = document.getElementById('drain_pump').value;

    if (!fillPump || !drainPump) {
        alert("Please select both filling and draining pumps.");
        return;
    }

    // Send the selected pump assignments to the server via POST request
    fetch("{{ url_for('save_pump_assignment') }}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            fill_pump: fillPump,
            drain_pump: drainPump
        })
    })
    .then(response => response.json())
    .then(data => {
        // Handle the response from the server
        alert("Pump assignments saved successfully!");
    })
    .catch(error => {
        console.error('Error saving pump assignments:', error);
    });
}

// Function to load the solution level on page load
function loadSolutionLevel() {
    fetch("{{ url_for('get_solution_level') }}")
        .then(response => response.json())
        .then(data => {
            if (data.solution_level !== undefined) {
                solution_level = data.solution_level;
                document.getElementById("solution-level-slider").value = solution_level;
                document.getElementById("solution-level-display").textContent = solution_level + "%";
            }
        })
        .catch(error => {
            console.error("Error loading solution level:", error);
        });
}

// Load pump names dynamically into dropdowns
function loadPumpNames() {
    fetch("{{ url_for('pumps') }}")
        .then(response => response.json())
        .then(data => {
            let drainingPumpSelect = document.getElementById("drain_pump");
            let fillingPumpSelect = document.getElementById("fill_pump");

            data.pump_names.forEach(pump => {
                let drainingOption = document.createElement("option");
                drainingOption.value = pump;
                drainingOption.textContent = pump;
                drainingPumpSelect.appendChild(drainingOption);

                let fillingOption = document.createElement("option");
                fillingOption.value = pump;
                fillingOption.textContent = pump;
                fillingPumpSelect.appendChild(fillingOption);
            });

            // Load saved pump selections from app_config.json
            loadSavedPumpSelections();
        })
        .catch(error => {
            console.error("Error loading pump names:", error);
        });
}

function loadSavedPumpSelections() {
    fetch("{{ url_for('get_saved_pumps') }}")
        .then(response => response.json())
        .then(data => {
            if (data.fill_pump && data.drain_pump) {
                document.getElementById('fill_pump').value = data.fill_pump;
                document.getElementById('drain_pump').value = data.drain_pump;
            }
        })
        .catch(error => {
            console.error("Error loading saved pump selections:", error);
        });
}

// Function to fetch and display tank data
function fetchTankData() {
    fetch("{{ url_for('test_tanks_route') }}")
        .then(response => response.json())
        .then(data => {
            let tanksDisplay = document.getElementById("tanks-display");
            tanksDisplay.innerHTML = '';
            
            Object.keys(data).forEach(tank => {
                let result = data[tank];
                let tankDiv = document.createElement("div");
                tankDiv.className = "tank-card";
                tankDiv.style = "text-align: center; margin: 10px; display: inline-block;";
                tankDiv.innerHTML = `
                    <div style="height: 200px; width: 50px; background-color: #ddd; border: 1px solid #333; position: relative;">
                        <div id="${tank}-fill-bar" style="position: absolute; bottom: 0; width: 100%; background-color: green; height: ${result.fill_percentage}%;"></div>
                    </div>
                    <h4>${tank}</h4>
                    <p>Arduino Code: ${result.arduino_code}</p>
                    <p>Total Volume: ${result.total_volume} L</p>
                    <p>Full: ${result.full_cm} cm</p>
                    <p>Empty: ${result.empty_cm} cm</p>
                    <p>Fill Level: ${result.fill_percentage}%</p>
                `;
                tanksDisplay.appendChild(tankDiv);
            });
        })
        .catch(error => {
            console.error("Error fetching tank data:", error);
        });
}

// Load tank data and pump names on page load
window.onload = function() {
    fetchTankData();
    loadSolutionLevel();
    loadPumpNames();
    loadSavedPumpSelections();
};

// Save pump assignments on form submission
document.getElementById('pumpForm').addEventListener('submit', function(event) {
    event.preventDefault();
    
    const fillPump = document.getElementById('fill_pump').value;
    const drainPump = document.getElementById('drain_pump').value;

    fetch('/save_pump_assignment', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ fill_pump: fillPump, drain_pump: drainPump })
    })
    .then(response => response.json())
    .then(data => alert(data.message))
    .catch(error => console.error('Error saving pump assignments:', error));
});
</script>

<hr>


<script>

function compareSolutionLevel() {
    // Show the progress bar container
    let progressContainer = document.getElementById("progress-container");
    let progressBar = document.getElementById("progress-bar");
    progressContainer.style.display = 'block';
    progressBar.style.width = '0%';  // Reset progress

    // Simulate progress for 5 seconds (adjust as needed)
    let duration = 5000;  // 5 seconds
    let intervalTime = 100;  // Update every 100ms
    let elapsedTime = 0;

    // Start the progress animation
    let progressInterval = setInterval(() => {
        elapsedTime += intervalTime;
        let progress = Math.min((elapsedTime / duration) * 100, 100);
        progressBar.style.width = progress + '%';

        if (progress >= 100) {
            clearInterval(progressInterval);
        }
    }, intervalTime);

    // Fetch solution level comparison data
    fetch("{{ url_for('compare_solution_level') }}")
        .then(response => response.json())
        .then(data => {
            let resultsDisplay = document.getElementById("adjustment-results");
            resultsDisplay.innerHTML = '';  // Clear previous results

            // Display only the 'solution' tank results
            if (data.solution) {
                let result = data.solution;
                let resultDiv = document.createElement("div");
                resultDiv.className = "tank-result";
                resultDiv.style = "margin: 10px; padding: 10px; border: 1px solid #ccc;";
                resultDiv.innerHTML = `
                    <h4>Solution Tank</h4>
                    <p>Action: ${result.action}</p>
                    <p>Volume to ${result.action === 'drain' ? 'drain' : 'add'}: ${result.volume_liters.toFixed(2)} L</p>
                `;
                resultsDisplay.appendChild(resultDiv);
            }

            // Hide the progress bar after completion
            setTimeout(() => {
                progressContainer.style.display = 'none';
            }, 500);  // Slight delay for smooth transition
        })
        .catch(error => {
            console.error("Error fetching solution level comparison:", error);
            
            // Hide the progress bar on error
            progressContainer.style.display = 'none';
        });
}

</script>




<script>
document.getElementById("solution-level-slider").addEventListener("input", function(event) {
    solution_level = event.target.value;
    document.getElementById("solution-level-display").textContent = solution_level + "%";
});

document.getElementById("save-solution-level-button").addEventListener("click", function() {
    const drainingPump = document.getElementById("drain_pump").value;
    const fillingPump = document.getElementById("fill_pump").value;

    if (!drainingPump || !fillingPump) {
        alert("Please select both draining and filling pumps.");
        return;
    }

    // Send the current solution level and pump selections to the server to save to JSON
    fetch("{{ url_for('save_solution_level') }}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ 
            solution_level: solution_level,
            draining_pump: drainingPump,
            filling_pump: fillingPump
        })
    })
    .then(response => response.json())
    .then(data => {
        alert("Solution level and pump settings saved successfully!");
    })
    .catch(error => {
        console.error("Error saving solution level:", error);
    });
});
</script>
    <script>
        document.getElementById('adjustTankButton').addEventListener('click', function() {
            // Send a POST request to the '/adjust_solution_tank' route
            fetch("{{ url_for('adjust_solution_tank') }}", {
                method: "POST"
            })
            .then(response => response.json())
            .then(data => {
                // Display the result message
                const responseMessageDiv = document.getElementById("responseMessage");
                if (data.status === "success") {
                    responseMessageDiv.innerHTML = `<p>Success: ${data.message}</p>`;
                } else {
                    responseMessageDiv.innerHTML = `<p>Error: ${data.message}</p>`;
                }
            })
            .catch(error => {
                console.error("Error calling adjust_tank_level:", error);
            });
        });
    </script>
{% endblock %}
