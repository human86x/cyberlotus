{% extends "base.html" %}

{% block content %}
<h1>Tank Calibration</h1>

<form id="calibrationForm">
    <label for="tank_name">Tank Name:</label>
    <select name="tank_name" id="tank_name" style="width: 200px;" required>
        {% for tank in tank_names %}
            <option value="{{ tank }}">{{ tank }}</option>
        {% endfor %}
    </select>
    <br><br>

    <label for="sensor_name">Sensor Name:</label>
    <select name="sensor_name" id="sensor_name" style="width: 200px;" required>
        {% for sensor in sensor_names %}
            <option value="{{ sensor }}">{{ sensor }}</option>
        {% endfor %}
    </select>
    <br><br>

    <label>Select Draining Pumps:</label><br>
    {% for pump in pump_names %}
        <input type="checkbox" name="drain_pumps" value="{{ pump }}"> {{ pump }}<br>
    {% endfor %}
    <br>

    <label>Select Filling Pumps:</label><br>
    {% for pump in pump_names %}
        <input type="checkbox" name="fill_pumps" value="{{ pump }}"> {{ pump }}<br>
    {% endfor %}
    <br>

    <h3>Calibration</h3>
    <button type="button" onclick="startCalibration()">Start Calibration</button>
    <button type="button" onclick="emergencyStop()" style="color: red;">ðŸš¨ Emergency Stop</button>
</form>

<!-- Progress Bar -->
<div id="progressContainer" style="display:none; margin-top:20px;">
    <label for="progressBar">Progress:</label>
    <div style="width: 100%; background-color: #ccc;">
        <div id="progressBar" style="width: 0%; height: 30px; background-color: green; text-align: center; color: white;">
            0%
        </div>
    </div>
</div>

<script>
function startCalibration() {
    const tankName = document.getElementById('tank_name').value;
    const sensorName = document.getElementById('sensor_name').value;

    const drainPumps = Array.from(document.querySelectorAll('input[name="drain_pumps"]:checked')).map(cb => cb.value);
    const fillPumps = Array.from(document.querySelectorAll('input[name="fill_pumps"]:checked')).map(cb => cb.value);

    if (!tankName || !sensorName || drainPumps.length === 0 || fillPumps.length === 0) {
        alert('Please fill in all fields.');
        return;
    }

    const data = {
        tank_name: tankName,
        sensor_name: sensorName,
        drain_pumps: drainPumps,
        fill_pumps: fillPumps
    };

    document.getElementById('progressContainer').style.display = 'block';
    document.getElementById('progressBar').style.width = '0%';
    document.getElementById('progressBar').innerText = '0%';

    fetch('/start_calibration', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(() => trackProgress(tankName))
    .catch(error => console.error('Error:', error));
}

function trackProgress(tankName) {
    const interval = setInterval(() => {
        fetch(`/get_progress/${tankName}`)
            .then(response => response.json())
            .then(data => {
                const progress = data.progress;
                const progressBar = document.getElementById('progressBar');
                progressBar.style.width = progress + '%';
                progressBar.innerText = progress + '%';

                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        document.getElementById('progressContainer').style.display = 'none';
                    }, 2000);
                } else if (progress === -1) {
                    clearInterval(interval);
                    alert('Error occurred during the calibration.');
                }
            });
    }, 500);
}

function emergencyStop() {
    fetch('/emergency_stop', { method: 'POST' })
        .then(() => alert('Emergency stop activated!'))
        .catch(error => console.error('Error:', error));
}
</script>

<style>
    .alert.success { color: green; }
    .alert.error { color: red; }
</style>
{% endblock %}
